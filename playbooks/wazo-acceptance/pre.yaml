---
- hosts: all
  tasks:
    - name: Create user and SSH key in .ssh/id_rsa
      become: yes
      user:
        name: zuul-worker
        generate_ssh_key: yes
        ssh_key_file: "~/.ssh/id_rsa"

    - name: Capturing SSH Keys
      command: "cat ~/.ssh/id_rsa.pub"
      register: "_ssh_pub_key"

    - name: Set authorized key for root
      become: yes
      authorized_key:
        user: root
        state: present
        key: "{{ _ssh_pub_key.stdout }}"

    - name: Validate root key
      shell: "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o PreferredAuthentications=publickey root@localhost -n \"/bin/ls\""

    - name: Install ansible
      become: yes
      apt:
        name: ansible
        state: present

    - name: Install postgresql ansible module from galaxy
      become: yes
      command: "ansible-galaxy install -r requirements-postgresql.yml"
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-ansible"

    - name: Install playwright dependencies
      become: yes
      apt:
        state: present
        name:
          - libnss3
          - libnspr4
          - libatk1.0-0
          - libatk-bridge2.0-0
          - libcups2
          - libdrm2
          - libatspi2.0-0
          - libx11-6
          - libxcomposite1
          - libxdamage1
          - libxext6
          - libxfixes3
          - libxrandr2
          - libgbm1
          - libxcb1
          - libxkbcommon0
          - libpango-1.0-0
          - libcairo2
          - libasound2
          - libx11-xcb1
          - libxcursor1
          - libxi6
          - libgtk-3-0
          - libpangocairo-1.0-0
          - libcairo-gobject2
          - libgdk-pixbuf-2.0-0
