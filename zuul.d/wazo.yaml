---
- nodeset:
    name: pod-debian-10
    nodes:
      - label: pod-debian-10
        name: pod-debian-10

- nodeset:
    name: pod-node-12
    nodes:
      - label: pod-node-12
        name: pod-node-12

- nodeset:
    name: pod-python-27
    nodes:
      - label: pod-python-27
        name: pod-python-27

- nodeset:
    name: vm-debian-10-m1s
    nodes:
      - label: vm-debian-10-m1s
        name: vm-debian-10-m1s

- nodeset:
    name: vm-debian-10-m2s
    nodes:
      - label: vm-debian-10-m2s
        name: vm-debian-10-m2s

- nodeset:
    name: vm-debian-10-m1m
    nodes:
      - label: vm-debian-10-m1m
        name: vm-debian-10-m1m

- job:
    name: wazo-tox
    parent: tox
    description: |
      Run tox

      Like tox but
      * install sibling packages in virtualenv for Depends-On too
      * install sibling packages in docker compose environement for integration if enabled
        with docker_install_siblings
    run: playbooks/wazo-tox/run.yaml
    post-run: playbooks/wazo-tox/post.yaml

- job:
    name: wazo-tox-molecule
    parent: wazo-tox
    vars:
      tox_envlist: molecule

- job:
    name: wazo-tox-integration
    parent: wazo-tox
    vars:
      docker_install_siblings: true
      tox_envlist: integration
    run: playbooks/wazo-tox-integration/run.yaml

- job:
    name: wazo-tox-py27
    parent: wazo-tox
    vars:
      tox_envlist: py27

- job:
    name: wazo-tox-py37
    parent: wazo-tox
    vars:
      tox_envlist: py37

- job:
    name: debian-packaging
    run: playbooks/debian-packaging/run.yaml
    provides: repo

- job:
    name: docker-build
    run: playbooks/docker-build/run.yaml

- job:
    name: wazo-c4-docker-build-test
    run: playbooks/wazo-c4-docker-build-test/run.yaml
    post-run: playbooks/wazo-c4-test/fetch-logs.yaml

- job:
    name: wazo-c4-test
    run: playbooks/wazo-c4-test/run.yaml
    post-run: playbooks/wazo-c4-test/fetch-logs.yaml

- job:
    name: yarn-build
    description: Run yarn build
    parent: base
    run: playbooks/yarn-build/run.yaml

- job:
    name: yarn-test
    description: Run yarn test
    parent: base
    run: playbooks/yarn-test/run.yaml

- job:
    name: wazo-acceptance-job
    description: install Wazo platform and run acceptance tests
    required-projects:
      - wazo-platform/wazo-ansible
      - wazo-platform/wazo-acceptance
      - wazo-platform/xivo-ci
    timeout: 10800
    pre-run: playbooks/wazo-acceptance/pre.yaml
    run: playbooks/wazo-acceptance/run.yaml
    post-run: playbooks/wazo-acceptance/fetch-logs.yaml

- job:
    name: wazo-ansible-uc-job
    description: Install Wazo Platform UC use case
    timeout: 10800
    pre-run: playbooks/wazo-ansible/pre.yaml
    run: playbooks/wazo-ansible/run.yaml
    post-run: playbooks/wazo-ansible/fetch-logs.yaml
    vars:
      wazo_debian_repo: main
      wazo_distribution: wazo-dev-buster
    required-projects:
      - wazo-platform/xivo-ci

- project-template:
    name: wazo-ansible-uc-template
    description: Project template to test the UC installer
    check:
      jobs:
        - wazo-ansible-uc-job:
            nodeset: vm-debian-10-m1s
    gate:
      jobs:
        - wazo-ansible-uc-job:
            nodeset: vm-debian-10-m1s

- project-template:
    name: wazo-tox-py37-vm
    description: Project template for tox -e py37
    check:
      jobs:
        - wazo-tox-py37:
            nodeset: vm-debian-10-m1s
    gate:
      jobs:
        - wazo-tox-py37:
            nodeset: vm-debian-10-m1s
    auto-merge:
      jobs:
        - wazo-tox-py37:
            nodeset: vm-debian-10-m1s

- project-template:
    name: wazo-tox-py37
    description: Project template for tox -e py37
    check:
      jobs:
        - wazo-tox-py37:
            nodeset: pod-debian-10
    gate:
      jobs:
        - wazo-tox-py37:
            nodeset: pod-debian-10
    auto-merge:
      jobs:
        - wazo-tox-py37:
            nodeset: pod-debian-10

- project-template:
    name: wazo-tox-linters
    description: Project template for tox -e linters
    check:
      jobs:
        - tox-linters:
            nodeset: pod-debian-10
    gate:
      jobs:
        - tox-linters:
            nodeset: pod-debian-10
    auto-merge:
      jobs:
        - tox-linters:
            nodeset: pod-debian-10

- project-template:
    name: wazo-tox-py27
    description: Project template for tox -e py27
    check:
      jobs:
        - wazo-tox-py27:
            nodeset: pod-python-27
    gate:
      jobs:
        - wazo-tox-py27:
            nodeset: pod-python-27
    auto-merge:
      jobs:
        - wazo-tox-py27:
            nodeset: pod-python-27

- project-template:
    name: wazo-tox-integration
    description: Project template for tox -e integration
    check:
      jobs:
        - wazo-tox-integration:
            nodeset: vm-debian-10-m1s
    gate:
      jobs:
        - wazo-tox-integration:
            nodeset: vm-debian-10-m1s
    auto-merge:
      jobs:
        - wazo-tox-integration:
            nodeset: vm-debian-10-m1s

- project-template:
    name: molecule
    description: Project template for tox -e molecule
    check:
      jobs:
        - wazo-tox-molecule:
            nodeset: vm-debian-10-m1s
    gate:
      jobs:
        - wazo-tox-molecule:
            nodeset: vm-debian-10-m1s
    auto-merge:
      jobs:
        - wazo-tox-molecule:
            nodeset: vm-debian-10-m1s

- project-template:
    name: docker-build-template
    description: Project template to build a Docker image
    check:
      jobs:
        - docker-build:
            nodeset: vm-debian-10-m1s
    gate:
      jobs:
        - docker-build:
            nodeset: vm-debian-10-m1s
    auto-merge:
      jobs:
        - docker-build:
            nodeset: vm-debian-10-m1s

- project-template:
    name: wazo-c4-test-template
    description: Project template to test wazo-c4
    check:
      jobs:
        - wazo-c4-test:
            nodeset: vm-debian-10-m1s
    gate:
      jobs:
        - wazo-c4-test:
            nodeset: vm-debian-10-m1s
    auto-merge:
      jobs:
        - wazo-c4-test:
            nodeset: vm-debian-10-m1s

- project-template:
    name: wazo-c4-docker-build-test-template
    description: Project template to build and test a C4 docker image
    check:
      jobs:
        - wazo-c4-docker-build-test:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/wazo-c4
    gate:
      jobs:
        - wazo-c4-docker-build-test:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/wazo-c4
    auto-merge:
      jobs:
        - wazo-c4-docker-build-test:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/wazo-c4

- project-template:
    name: debian-packaging-template
    description: Project template to build Debian packages
    check:
      jobs:
        - debian-packaging:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/xivo-ci
    gate:
      jobs:
        - debian-packaging:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/xivo-ci
    auto-merge:
      jobs:
        - debian-packaging:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/xivo-ci
    experimental:
      jobs:
        - wazo-ansible-uc-job:
            nodeset: vm-debian-10-m1s
            required-projects: wazo-platform/wazo-ansible

- project-template:
    name: yarn-template
    description: Project template for yarn based tasks
    check:
      jobs:
        - yarn-build:
            nodeset: pod-node-12
        - yarn-test:
            nodeset: pod-node-12
    gate:
      jobs:
        - yarn-build:
            nodeset: pod-node-12
        - yarn-test:
            nodeset: pod-node-12
    auto-merge:
      jobs:
        - yarn-build:
            nodeset: pod-node-12
        - yarn-test:
            nodeset: pod-node-12
